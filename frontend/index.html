<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>URVASEO - Login</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f2f5;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .login-container {
      background-color: #ffffff;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    h1 {
      color: #333;
      margin-bottom: 25px;
      font-size: 2em;
    }
    .form-box {
      margin-bottom: 15px;
    }
    input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 1em;
      transition: border-color 0.3s;
    }
    input:focus {
      outline: none;
      border-color: #007bff;
    }
    .hidden {
      display: none;
    }
    #placa-list {
      list-style: none;
      padding: 0;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      max-height: 150px;
      overflow-y: auto;
    }
    #placa-list li {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    #placa-list li:last-child {
      border-bottom: none;
    }
    #placa-list li:hover {
      background-color: #f4f4f4;
    }
    button {
      width: 100%;
      padding: 12px 15px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    #message-box {
      margin-top: 20px;
      padding: 10px;
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      border-radius: 5px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <h1>URVASEO Login</h1>
    
    <div id="message-box" class="hidden"></div>

    <div class="form-box">
      <input type="text" id="username" placeholder="Usuario" autocomplete="off" required>
    </div>
    <div class="form-box">
      <input type="password" id="password" placeholder="Contraseña" autocomplete="off" required>
    </div>
    <div class="form-box hidden" id="placaInputBox">
      <input type="text" id="placaInput" placeholder="Selecciona tu Placa" autocomplete="off">
      <ul id="placa-list"></ul>
    </div>
    
    <button onclick="login()">Iniciar Sesión</button>

    <p style="margin-top: 20px;">
      ¿No tienes una cuenta? <a href="register.html" style="color: #007bff; text-decoration: none;">Regístrate aquí</a>
    </p>
  </div>
  
  <script>
    const API = "https://urvaseo-backend.onrender.com";
    let placaSeleccionada = null;

    // Función para mostrar mensajes en una caja de texto
    function showMessage(message, isError = true) {
      const messageBox = document.getElementById("message-box");
      messageBox.innerText = message;
      messageBox.style.backgroundColor = isError ? "#f8d7da" : "#d4edda";
      messageBox.style.color = isError ? "#721c24" : "#155724";
      messageBox.classList.remove("hidden");
    }

    // Ocultar mensaje al interactuar con el formulario
    function hideMessage() {
        document.getElementById("message-box").classList.add("hidden");
    }

    document.getElementById("username").addEventListener("focus", hideMessage);
    document.getElementById("password").addEventListener("focus", hideMessage);
    document.getElementById("placaInput").addEventListener("focus", hideMessage);

    // Evento que se dispara al hacer clic/tocar o presionar tab en el campo de contraseña
    document.getElementById("password").addEventListener("focus", async () => {
      const username = document.getElementById("username").value;
      if (username.trim() === "") return;

      try {
        const res = await fetch(`${API}/check-role`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username })
        });

        if (res.ok) {
          const data = await res.json();
          if (data.role === "chofer") {
            document.getElementById("placaInputBox").classList.remove("hidden");
            cargarPlacasActivas();
          } else {
            document.getElementById("placaInputBox").classList.add("hidden");
          }
        } else {
          // Si el usuario no existe, ocultamos todo lo que se necesite
          document.getElementById("placaInputBox").classList.add("hidden");
        }
      } catch (err) {
        console.error("Error al verificar el rol:", err);
        document.getElementById("placaInputBox").classList.add("hidden");
      }
    });

    // Carga las placas activas
    async function cargarPlacasActivas() {
      const placaInput = document.getElementById("placaInput");
      const placaList = document.getElementById("placa-list");

      try {
        const res = await fetch(`${API}/placas-activas`);
        const placas = await res.json();

        placaList.innerHTML = "";
        placas.forEach(p => {
          const li = document.createElement("li");
          li.innerText = p.placa;
          li.addEventListener("click", () => {
            placaInput.value = p.placa;
            placaSeleccionada = p.placa;
            placaList.innerHTML = "";
          });
          placaList.appendChild(li);
        });

      } catch (err) {
        console.error("Error al cargar las placas:", err);
      }
    }

    // Lógica de login
    async function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      const placa = placaSeleccionada;

      if (username.trim() === "" || password.trim() === "") {
        return showMessage("Todos los campos son obligatorios.");
      }
      
      try {
        const res = await fetch(`${API}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password, placa }),
        });

        const data = await res.json();

        if (data.ok) {
          localStorage.setItem("username", username);
          localStorage.setItem("placa", data.placa);
          
          if (data.role === "chofer") {
            window.location.href = "chofer.html";
          } else if (data.role === "supervisor") {
            window.location.href = "supervisor.html";
          } else if (data.role === "admin") {
            window.location.href = "admin.html";
          }
        } else {
          showMessage(data.msg);
        }
      } catch (err) {
        console.error("Error al iniciar sesión:", err);
        showMessage("Error de conexión. Por favor, intenta de nuevo más tarde.");
      }
    }
  </script>
</body>
</html>
