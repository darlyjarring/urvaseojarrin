<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>URVASEO - Gestión de Placas</title>
  <!-- Enlace a la biblioteca de Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

  <!-- Contenedor principal centrado -->
  <div class="container mx-auto p-4 md:p-8">
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-10">

      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-6 border-b-2 pb-4">Gestión de Placas</h1>

      <!-- Sección para registrar nuevas placas -->
      <div class="bg-gray-50 rounded-lg p-6 mb-8 shadow-inner">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Registrar Nueva Placa</h2>
        <div class="flex flex-col md:flex-row gap-4">
          <input id="nuevaPlaca" type="text" placeholder="Ej: ABC-1234" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          <select id="estadoPlaca" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="activo">Activo</option>
            <option value="inactivo">Inactivo</option>
          </select>
          <button id="btnRegistrar" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out shadow-md">
            Registrar
          </button>
        </div>
      </div>

      <!-- Sección para el listado de placas -->
      <div>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Listado de Placas</h2>
        <div class="overflow-x-auto rounded-lg shadow-md">
          <table id="tablaPlacas" class="min-w-full bg-white border-collapse">
            <thead>
              <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                <th class="py-3 px-6 text-left">#</th>
                <th class="py-3 px-6 text-left">Placa</th>
                <th class="py-3 px-6 text-left">Estado</th>
                <th class="py-3 px-6 text-left">Acciones</th>
              </tr>
            </thead>
            <tbody class="text-gray-600 text-sm font-light">
              <!-- Los datos de las placas se insertarán aquí -->
              <tr>
                <td colspan="4" class="py-4 text-center text-gray-500">Cargando placas...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- Contenedor para notificaciones y modales -->
  <div id="modal-container"></div>
  <div id="notification-container" class="fixed bottom-5 right-5 z-50"></div>
  
  <script>
    // -------------------- VARIABLES GLOBALES --------------------
    const API = "https://urvaseo-backend.onrender.com";

    // -------------------- FUNCIONES DE UTILIDAD --------------------

    // Función para mostrar notificaciones personalizadas
    function showNotification(message, isError = true) {
      const notification = document.createElement("div");
      notification.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-xl text-white transition-transform duration-300 ease-out transform translate-y-full ${isError ? 'bg-red-500' : 'bg-green-500'} z-50`;
      notification.textContent = message;
      document.getElementById('notification-container').appendChild(notification);
      
      // Animar la entrada
      setTimeout(() => {
        notification.style.transform = 'translateY(0)';
      }, 100);

      // Animar la salida y eliminar después de 3 segundos
      setTimeout(() => {
        notification.style.transform = 'translateY(100%)';
        notification.addEventListener('transitionend', () => notification.remove());
      }, 3000);
    }

    // Función para mostrar un modal de confirmación
    function showConfirmationModal(message, onConfirm) {
      const modalContainer = document.getElementById('modal-container');
      const modal = document.createElement("div");
      modal.className = "fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50";
      modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-xl w-80 text-center">
          <p class="mb-4 text-lg font-semibold">${message}</p>
          <div class="flex justify-around">
            <button id="confirm-yes" class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition">Sí</button>
            <button id="confirm-no" class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition">No</button>
          </div>
        </div>
      `;
      modalContainer.appendChild(modal);

      document.getElementById('confirm-yes').onclick = () => {
        onConfirm(true);
        modal.remove();
      };
      document.getElementById('confirm-no').onclick = () => {
        onConfirm(false);
        modal.remove();
      };
    }

    // -------------------- FUNCIONES DE GESTIÓN DE PLACAS --------------------

    // 🔹 Cargar y mostrar todas las placas
    async function cargarPlacas() {
      const tablaPlacasBody = document.querySelector("#tablaPlacas tbody");
      tablaPlacasBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-500">Cargando placas...</td></tr>`;
      try {
        const res = await fetch(`${API}/placas`);
        if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
        const placas = await res.json();
        
        tablaPlacasBody.innerHTML = "";
        
        if (placas.length === 0) {
          tablaPlacasBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-500">No hay placas registradas.</td></tr>`;
          return;
        }

        placas.forEach((p, i) => {
          const tr = document.createElement("tr");
          const estadoTexto = p.estado === "activo" ? "Activa" : "Inactiva";
          const estadoClase = p.estado === "activo" ? "text-green-600 font-bold" : "text-red-600 font-bold";
          tr.className = `border-b border-gray-200 hover:bg-gray-50`;
          tr.innerHTML = `
            <td class="py-3 px-6 text-left whitespace-nowrap">${i + 1}</td>
            <td class="py-3 px-6 text-left">${p.placa}</td>
            <td class="py-3 px-6 text-left ${estadoClase}">${estadoTexto}</td>
            <td class="py-3 px-6 text-left">
              <button onclick="editarPlaca('${p._id}', '${p.estado}')" class="bg-yellow-500 text-white py-1 px-3 rounded-lg hover:bg-yellow-600 transition duration-300 shadow-md">
                Alternar Estado
              </button>
            </td>
          `;
          tablaPlacasBody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error al cargar las placas:", err);
        tablaPlacasBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-red-500">Error al cargar placas. Intenta de nuevo.</td></tr>`;
      }
    }

    // 🔹 Registrar nueva placa
    async function registrarPlaca() {
      const placaInput = document.getElementById("nuevaPlaca");
      const estadoSelect = document.getElementById("estadoPlaca");
      const placa = placaInput.value.trim();
      const estado = estadoSelect.value;

      if (!placa) {
        showNotification("Debe ingresar una placa.");
        return;
      }

      try {
        const res = await fetch(`${API}/placas`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ placa, estado })
        });

        const data = await res.json();
        if (res.ok) {
          placaInput.value = "";
          showNotification("Placa registrada con éxito.", false);
          cargarPlacas();
        } else {
          showNotification(`Error: ${data.error || res.statusText}`);
        }
      } catch (err) {
        console.error("Error al registrar la placa:", err);
        showNotification("Error de conexión. Intenta de nuevo más tarde.");
      }
    }

    // 🔹 Editar estado de placa (CORREGIDO)
    async function editarPlaca(id, estadoActual) {
      const nuevoEstado = estadoActual === "activo" ? "inactivo" : "activo";
      showConfirmationModal(`¿Estás seguro de que quieres cambiar el estado de la placa a '${nuevoEstado}'?`, async (confirmed) => {
        if (confirmed) {
          try {
            const res = await fetch(`${API}/placas/${id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ estado: nuevoEstado })
            });
            
            if (res.ok) {
              showNotification("Estado de la placa actualizado con éxito.", false);
              cargarPlacas();
            } else {
              const errorData = await res.json();
              showNotification(`Error: ${errorData.error || res.statusText}`);
            }
          } catch (err) {
            console.error("Error al actualizar la placa:", err);
            showNotification("Error de conexión. Intenta de nuevo más tarde.");
          }
        }
      });
    }

    // -------------------- INICIALIZACIÓN --------------------
    document.addEventListener("DOMContentLoaded", () => {
      // Cargar las placas al iniciar la página
      cargarPlacas();

      // Añadir evento al botón de registro
      document.getElementById('btnRegistrar').addEventListener('click', registrarPlaca);
    });
  </script>
</body>
</html>
